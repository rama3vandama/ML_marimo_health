"""
my_dashboard.py - –ü–æ–ª–Ω—ã–π Marimo –¥—ç—à–±–æ—Ä–¥ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
"""

import marimo as mo
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# ==================== 1. –°–û–ó–î–ê–ï–ú –î–ï–ú–û-–î–ê–ù–ù–´–ï ====================
def create_sample_data():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö"""
    np.random.seed(42)
    
    # –ì–æ—Ä–æ–¥–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã
    cities = ['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å']
    products = ['–ù–æ—É—Ç–±—É–∫–∏', '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã', '–ü–ª–∞–Ω—à–µ—Ç—ã', '–ù–∞—É—à–Ω–∏–∫–∏', '–ú–æ–Ω–∏—Ç–æ—Ä—ã']
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    data = []
    start_date = datetime(2024, 1, 1)
    
    for i in range(200):
        city = np.random.choice(cities)
        product = np.random.choice(products)
        date = start_date + timedelta(days=np.random.randint(0, 365))
        
        # –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        base_prices = {
            '–ù–æ—É—Ç–±—É–∫–∏': 50000,
            '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã': 30000,
            '–ü–ª–∞–Ω—à–µ—Ç—ã': 25000,
            '–ù–∞—É—à–Ω–∏–∫–∏': 8000,
            '–ú–æ–Ω–∏—Ç–æ—Ä—ã': 20000
        }
        
        quantity = np.random.randint(1, 10)
        price = base_prices[product] * np.random.uniform(0.8, 1.2)
        revenue = quantity * price
        profit = revenue * np.random.uniform(0.15, 0.35)
        
        data.append({
            '–î–∞—Ç–∞': date,
            '–ì–æ—Ä–æ–¥': city,
            '–ü—Ä–æ–¥—É–∫—Ç': product,
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': quantity,
            '–¶–µ–Ω–∞': price,
            '–í—ã—Ä—É—á–∫–∞': revenue,
            '–ü—Ä–∏–±—ã–ª—å': profit,
            '–î–æ—Å—Ç–∞–≤–∫–∞': np.random.choice(['–î–∞', '–ù–µ—Ç'], p=[0.7, 0.3])
        })
    
    return pd.DataFrame(data)

# –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ
sales_data = create_sample_data()

# ==================== 2. –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ====================
city_filter = mo.ui.dropdown(
    options=sorted(sales_data['–ì–æ—Ä–æ–¥'].unique()),
    value='–ú–æ—Å–∫–≤–∞',
    label="üèôÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:"
)

product_filter = mo.ui.dropdown(
    options=sorted(sales_data['–ü—Ä–æ–¥—É–∫—Ç'].unique()),
    value='–ù–æ—É—Ç–±—É–∫–∏',
    label="üì¶ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞:"
)

date_range = mo.ui.date_range(
    label="üìÖ –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç:",
    value=(
        sales_data['–î–∞—Ç–∞'].min(),
        sales_data['–î–∞—Ç–∞'].max()
    )
)

show_delivery = mo.ui.checkbox(
    label="üöö –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π"
)

# ==================== 3. –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• ====================
@mo.cache
def filter_data():
    """–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º"""
    filtered = sales_data[
        (sales_data['–ì–æ—Ä–æ–¥'] == city_filter.value) &
        (sales_data['–ü—Ä–æ–¥—É–∫—Ç'] == product_filter.value) &
        (sales_data['–î–∞—Ç–∞'] >= date_range.value[0]) &
        (sales_data['–î–∞—Ç–∞'] <= date_range.value[1])
    ]
    
    if show_delivery.value:
        filtered = filtered[filtered['–î–æ—Å—Ç–∞–≤–∫–∞'] == '–î–∞']
    
    return filtered

# ==================== 4. –†–ê–°–ß–ï–¢ –°–¢–ê–¢–ò–°–¢–ò–ö ====================
@mo.cache
def calculate_statistics():
    """–†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫"""
    df = filter_data()
    
    if len(df) == 0:
        return {
            'total_revenue': 0,
            'total_profit': 0,
            'avg_price': 0,
            'total_quantity': 0,
            'orders': 0
        }
    
    return {
        'total_revenue': df['–í—ã—Ä—É—á–∫–∞'].sum(),
        'total_profit': df['–ü—Ä–∏–±—ã–ª—å'].sum(),
        'avg_price': df['–¶–µ–Ω–∞'].mean(),
        'total_quantity': df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'].sum(),
        'orders': len(df)
    }

# ==================== 5. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø ====================
@mo.cache
def create_visualization():
    """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π"""
    df = filter_data()
    stats = calculate_statistics()
    
    # –ü–∞–Ω–µ–ª—å –º–µ—Ç—Ä–∏–∫
    metrics_panel = mo.md(f"""
    ## üìä –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    
    | –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –ó–Ω–∞—á–µ–Ω–∏–µ |
    |------------|----------|
    | –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ | **{stats['total_revenue']:,.0f} ‚ÇΩ** |
    | –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å | **{stats['total_profit']:,.0f} ‚ÇΩ** |
    | –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ | **{stats['avg_price']:,.0f} ‚ÇΩ** |
    | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ | **{stats['total_quantity']}** —à—Ç. |
    | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ | **{stats['orders']}** |
    """)
    
    # –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    if len(df) > 0:
        table = mo.ui.table(df.sort_values('–î–∞—Ç–∞', ascending=False).head(10))
    else:
        table = mo.md("### –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º")
    
    # –°–≤–æ–¥–∫–∞ –ø–æ –¥–∞—Ç–∞–º
    if len(df) > 0:
        daily_summary = df.groupby(df['–î–∞—Ç–∞'].dt.date).agg({
            '–í—ã—Ä—É—á–∫–∞': 'sum',
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': 'sum'
        }).reset_index()
        
        summary_table = mo.ui.table(daily_summary.tail(7))
    else:
        summary_table = mo.md("")
    
    return mo.vstack([
        metrics_panel,
        mo.md("### üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã:"),
        table,
        mo.md("### üìà –°–≤–æ–¥–∫–∞ –ø–æ –¥–Ω—è–º:"),
        summary_table
    ])

# ==================== 6. –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ ====================
info_panel = mo.accordion({
    "‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É": mo.md(f"""
    ## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç –¥—ç—à–±–æ—Ä–¥
    
    ### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:
    ```bash
    # 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    pip install marimo pandas numpy
    
    # 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥—ç—à–±–æ—Ä–¥
    marimo edit my_dashboard.py
    
    # 3. –û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ –∞–¥—Ä–µ—Å—É:
    # http://localhost:8080
    ```
    
    ### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:
    - **–ì–æ—Ä–æ–¥**: {city_filter.value}
    - **–ü—Ä–æ–¥—É–∫—Ç**: {product_filter.value}
    - **–î–∞—Ç—ã**: {date_range.value[0].date()} - {date_range.value[1].date()}
    - **–î–æ—Å—Ç–∞–≤–∫–∞**: {'–î–∞' if show_delivery.value else '–ù–µ—Ç'}
    
    ### –î–∞–Ω–Ω—ã–µ:
    - –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(sales_data)}
    - –ü–µ—Ä–∏–æ–¥: {sales_data['–î–∞—Ç–∞'].min().date()} - {sales_data['–î–∞—Ç–∞'].max().date()}
    """),
    
    "üìÅ –û –ø—Ä–æ–µ–∫—Ç–µ": mo.md("""
    ## üìä Marimo –¥—ç—à–±–æ—Ä–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–¥–∞–∂
    
    **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
    - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –≥–æ—Ä–æ–¥—É, –ø—Ä–æ–¥—É–∫—Ç—É –∏ –¥–∞—Ç–µ
    - –†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ (–≤—ã—Ä—É—á–∫–∞, –ø—Ä–∏–±—ã–ª—å)
    - –¢–∞–±–ª–∏—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    
    **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
    - Python 3.11+
    - Marimo 0.6+
    - Pandas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    - NumPy –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
    
    **–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:**
    ```
    üìÅ marimo-dashboard/
    ‚îú‚îÄ‚îÄ my_dashboard.py    # –≠—Ç–æ—Ç —Ñ–∞–π–ª
    ‚îú‚îÄ‚îÄ index.html         # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ GitHub Pages
    ‚îú‚îÄ‚îÄ dashboard_demo.html # –î–µ–º–æ-–≤–µ—Ä—Å–∏—è
    ‚îî‚îÄ‚îÄ README.md          # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    ```
    """)
})

# ==================== 7. –°–û–ë–ò–†–ê–ï–ú –ò–ù–¢–ï–†–§–ï–ô–° ====================
app = mo.vstack([
    mo.md("# üìà –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥—ç—à–±–æ—Ä–¥"),
    mo.md("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∏–∂–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"),
    
    # –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    mo.hstack([city_filter, product_filter]),
    mo.hstack([date_range, show_delivery]),
    
    # –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    mo.ui.button(
        label="üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã",
        on_click=lambda: (
            city_filter.set_value('–ú–æ—Å–∫–≤–∞'),
            product_filter.set_value('–ù–æ—É—Ç–±—É–∫–∏'),
            show_delivery.set_value(False)
        ),
        full_width=False
    ),
    
    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    create_visualization(),
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    info_panel,
    
    # –§—É—Ç–µ—Ä
    mo.md("---"),
    mo.md(f"""
    ### üìÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {datetime.now().strftime('%Y-%m-%d %H:%M')}
    *–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Å–≤–æ—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö*
    """)
])

# ==================== 8. –≠–ö–°–ü–û–†–¢ ====================
app
