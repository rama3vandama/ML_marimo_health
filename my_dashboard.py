"""
my_dashboard.py - –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥—ç—à–±–æ—Ä–¥ –Ω–∞ Marimo
"""

import marimo as mo
import numpy as np
import pandas as pd

# ==================== 1. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• (—Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö) ====================
# –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –ø—Ä—è–º–æ –≤ –∫–æ–¥–µ
data = pd.DataFrame({
    '–ì–æ—Ä–æ–¥': ['–ú–æ—Å–∫–≤–∞', '–°–ü–±', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å'] * 4,
    '–ú–µ—Å—è—Ü': ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä'] * 5,
    '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞': np.random.randint(-15, 25, 20),
    '–ü—Ä–æ–¥–∞–∂–∏': np.random.randint(100, 1000, 20)
})

# ==================== 2. –°–û–ó–î–ê–ï–ú –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ====================
# –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
city_dropdown = mo.ui.dropdown(
    options=sorted(data['–ì–æ—Ä–æ–¥'].unique()),
    value='–ú–æ—Å–∫–≤–∞',
    label="üéØ –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:"
)

# –°–ª–∞–π–¥–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
temp_slider = mo.ui.slider(
    start=int(data['–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'].min()),
    stop=int(data['–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'].max()),
    value=10,
    label="üå°Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:"
)

# ==================== 3. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–ò –î–ê–ù–ù–´–• ====================
@mo.cache  # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
def filter_data():
    """–§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º"""
    filtered = data[
        (data['–ì–æ—Ä–æ–¥'] == city_dropdown.value) &
        (data['–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'] >= temp_slider.value)
    ]
    return filtered

# ==================== 4. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ê–°–ß–ï–¢–ê –°–¢–ê–¢–ò–°–¢–ò–ö ====================
@mo.cache
def calculate_stats():
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º"""
    df = filter_data()
    
    if len(df) == 0:
        return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º"
    
    stats = {
        '–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞': f"{df['–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'].mean():.1f}¬∞C",
        '–û–±—â–∏–µ –ø—Ä–æ–¥–∞–∂–∏': f"{df['–ü—Ä–æ–¥–∞–∂–∏'].sum():,} ‚ÇΩ",
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π': len(df),
        '–ú–∞–∫—Å. —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞': f"{df['–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'].max()}¬∞C"
    }
    
    return stats

# ==================== 5. –°–û–ó–î–ê–ï–ú –¢–ê–ë–õ–ò–¶–£ –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ====================
@mo.cache
def create_table():
    """–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    df = filter_data()
    return mo.ui.table(df)

# ==================== 6. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ====================
@mo.cache
def display_results():
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"""
    stats = calculate_stats()
    table = create_table()
    
    return mo.vstack([
        mo.md(f"""
        ## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞: **{city_dropdown.value}**
        
        ### üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
        - **–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:** {stats['–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞']}
        - **–û–±—â–∏–µ –ø—Ä–æ–¥–∞–∂–∏:** {stats['–û–±—â–∏–µ –ø—Ä–æ–¥–∞–∂–∏']}
        - **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:** {stats['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π']}
        - **–ú–∞–∫—Å. —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:** {stats['–ú–∞–∫—Å. —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞']}
        """),
        mo.md("### üìã –î–∞–Ω–Ω—ã–µ:"),
        table
    ])

# ==================== 7. –°–û–ë–ò–†–ê–ï–ú –ò–ù–¢–ï–†–§–ï–ô–° –î–≠–®–ë–û–†–î–ê ====================
# –°–æ–∑–¥–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ –∏–∑ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
dashboard = mo.vstack([
    mo.md("# üìà –ú–æ–π –ø–µ—Ä–≤—ã–π Marimo –¥—ç—à–±–æ—Ä–¥"),
    mo.md("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∏–∂–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:"),
    
    # –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    mo.hstack([city_dropdown, temp_slider]),
    
    # –ö–Ω–æ–ø–∫–∞ (–¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, —Ö–æ—Ç—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ)
    mo.ui.button(
        label="üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ",
        on_click=lambda: None  # –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –Ω—É–∂–Ω–∞, —Ç.–∫. @mo.cache –æ–±–Ω–æ–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    ),
    
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    display_results(),
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
    mo.md("---"),
    mo.md("""
    ### ‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
    1. –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
    2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Å–ª–∞–π–¥–µ—Ä–æ–º
    3. –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è `@mo.cache`
    
    ### üöÄ –ó–∞–ø—É—Å–∫ —ç—Ç–æ–≥–æ –¥—ç—à–±–æ—Ä–¥–∞:
    - **–û–Ω–ª–∞–π–Ω:** [Marimo Cloud](https://editor.marimo.io)
    - **–õ–æ–∫–∞–ª—å–Ω–æ:** `marimo edit my_dashboard.py`
    """)
])

# ==================== 8. –≠–ö–°–ü–û–†–¢–ò–†–£–ï–ú –î–≠–®–ë–û–†–î ====================
# –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê - –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥—ç—à–±–æ—Ä–¥
dashboard
